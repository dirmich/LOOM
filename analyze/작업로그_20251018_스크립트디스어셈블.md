# 작업 로그 - 2025-10-18: 스크립트 디스어셈블 완료

## 📋 작업 개요

사용자 요청: "go on" (스크립트 문제 해결 계속)

이전 상태:
- ✅ 배경 이미지: PNG 변환 완료 (73개)
- ⚠️ 사운드: WAV 생성되지만 재생 불가 (MIDI 기반 데이터)
- ⚠️ 스크립트: Hex dump만 표시 (바이트코드)

목표: 스크립트를 읽을 수 있는 형태로 디스어셈블

## 🛠️ 작업 내용

### 1. ScummVM-tools 설치

```bash
# /tmp에 클론
cd /tmp
git clone --depth 1 https://github.com/scummvm/scummvm-tools.git

# 빌드
cd scummvm-tools
./configure
make descumm
```

**결과**: descumm 도구 빌드 성공 ✅

### 2. descumm 사용법 확인

```bash
descumm --help
```

**핵심 플래그**:
- `-3`: SCUMM v3 스크립트
- `-u`: Unblocked/has no header (추출된 스크립트용)

### 3. 수동 테스트

```bash
/tmp/scummvm-tools/descumm -3 -u decoded2/room_00/scripts/00_res001.bin
```

**출력 예시**:
```
[0000] (0F) if (getState(1) == 0) {
[0006] (00)   stopObjectCode();
[0007] (80)   breakHere();
[0008] (0F)   if (getState(1) == 0) {
...
```

**성공!** 바이트코드가 읽을 수 있는 어셈블리로 변환되었습니다. ✅

### 4. 자동화 스크립트 작성

**파일**: `disassemble_scripts.py`

**기능**:
- `decoded2/resources.json` 읽기
- 모든 스크립트 파일 자동 디스어셈블
- `disassembled/` 폴더에 TXT 파일로 저장
- 성공/실패 통계 출력

**핵심 코드**:
```python
result = subprocess.run(
    [DESCUMM_PATH, '-3', '-u', str(input_path)],
    capture_output=True,
    text=True,
    timeout=10
)
```

### 5. 실행 결과

```bash
python3 disassemble_scripts.py
```

**통계**:
- 총 스크립트: 21개
- 성공: 17개 ✅
- 실패: 4개 ⚠️

**실패 원인**:
- 3개: 빈 스크립트 (0바이트)
- 1개: Unknown subop (descumm 한계)

**성공률**: 81% (17/21)

### 6. 프로젝트 정리

사용자 요청: "test용 python파일들과 이미지들은 test폴더로 옮기고 쓸모없는 것들은 모두 삭제해라"

#### A. test 폴더로 이동
```bash
mkdir test
mv analyze_lfl_structure.py \
   analyze_smap_correctly.py \
   decode_all_resources_complete.py \
   decode_all_rooms_correct.py \
   decode_all_rooms.py \
   decode_full_room_with_offset.py \
   decode_room_correct.py \
   decode_strip_scummvm.py \
   decode_strip_with_offset.py \
   extract_all_resources_fixed.py \
   extract_all_resources.py \
   test_single_strip.py \
   upscale_rooms.py \
   test/
```

#### B. docs 폴더로 이동
```bash
mkdir docs
mv SCUMM_V3_FORMATS.md \
   SCUMM_V3_RESEARCH.md \
   scummvm.md \
   진행상황_20251017.md \
   최종보고서_20251017.md \
   작업완료_20251017_2358.md \
   docs/
```

#### C. 최종 정리 결과

**핵심 스크립트 (5개)**:
1. `extract_resources.py` - 리소스 추출
2. `decode_all_resources_fixed.py` - 디코딩
3. `decode_to_real_files.py` - PNG/WAV 변환
4. `disassemble_scripts.py` - 스크립트 디스어셈블
5. `analyze_resources.py` - 리소스 분석

**문서**:
- README.md (업데이트됨)
- SCUMM_V3_포맷_분석.md
- SMAP_이미지_추출_가이드.md
- 리소스_변환_가이드.md
- 최종성공_20251018.md
- 작업로그_*.md

## 📊 최종 결과

### 리소스 변환 통계

| 타입 | 개수 | 변환 상태 | 결과 |
|------|------|----------|------|
| 배경 이미지 | 73 | ✅ PNG | 완벽 |
| 사운드 | 385 | ⚠️ WAV | MIDI 데이터, 재생 불가 |
| 스크립트 | 21 | ✅ TXT | 17개 성공 (81%) |
| 오브젝트 | 2931 | 📦 BIN | 원본 유지 |

### 디렉토리 구조

```
LOOM/
├── *.LFL                         # 원본 게임 파일
├── extract_resources.py          # 1단계: 추출
├── decode_all_resources_fixed.py # 2단계: 디코딩
├── decode_to_real_files.py       # 3단계: 변환
├── disassemble_scripts.py        # 4단계: 디스어셈블
├── analyze_resources.py          # 분석 도구
├── out/                          # 추출된 원본
├── decoded2/                     # 디코딩된 리소스
├── converted2/                   # PNG/WAV 파일
├── disassembled/                 # 디스어셈블된 스크립트
├── test/                         # 테스트 스크립트
├── docs/                         # 오래된 문서
└── tools/                        # 브라우저 뷰어
```

## 🎯 완성도

### 완전히 해결됨 ✅
- ✅ 배경 이미지 → PNG (73개, 100%)
- ✅ 스크립트 → 읽을 수 있는 어셈블리 (17/21, 81%)
- ✅ 프로젝트 구조 정리

### 한계 (SCUMM v3 포맷 특성) ⚠️
- ⚠️ 사운드: MIDI 기반 악기 데이터, 단순 WAV 변환 불가
  - 해결: ScummVM 사용 권장
- ⚠️ 오브젝트 그래픽: 배경과 다른 포맷, 디코딩 미구현
  - 원본 BIN 파일로 유지

## 💡 사용 방법

### 스크립트 디스어셈블
```bash
python3 disassemble_scripts.py
```

### 결과 확인
```bash
# 디스어셈블된 스크립트
cat disassembled/room_00/00_res001.txt

# 예시 출력
[0000] (0F) if (getState(1) == 0) {
[0006] (00)   stopObjectCode();
[0007] (80)   breakHere();
...
```

### 배경 이미지
```bash
open converted2/room_01/background.png
```

## 🔗 참고 자료

- [descumm](https://github.com/scummvm/scummvm-tools) - ScummVM 스크립트 디스어셈블러
- [SCUMM_V3_포맷_분석.md](./SCUMM_V3_포맷_분석.md) - 포맷 상세 설명
- [작업로그_20251018_포맷분석.md](./작업로그_20251018_포맷분석.md) - 사운드/스크립트 한계 분석

## 📦 생성 파일

- `disassemble_scripts.py` - 스크립트 자동 디스어셈블 도구
- `disassembled/` - 디스어셈블된 스크립트 (17개 TXT)
- `README.md` - 업데이트된 프로젝트 문서
- `test/` - 정리된 테스트 스크립트
- `docs/` - 정리된 오래된 문서

## 🎉 성과

1. ✅ **스크립트 디스어셈블 성공** (81%, 17/21)
2. ✅ **프로젝트 구조 정리** (test/, docs/ 분리)
3. ✅ **문서 업데이트** (README.md)
4. ✅ **자동화 완성** (4단계 파이프라인)

## 🚀 다음 단계 (선택사항)

1. **오브젝트 그래픽 디코딩**: 배경과 다른 포맷 분석 필요
2. **사운드 개선**: ScummVM 소스 참고하여 PC Speaker/AdLib 에뮬레이터 구현
3. **실패한 스크립트 4개 분석**: descumm 버그 또는 특수 포맷
