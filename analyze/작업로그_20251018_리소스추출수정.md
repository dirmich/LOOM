# 작업 로그 - 2025-10-18: 리소스 추출 버그 수정

## 📋 작업 개요

사용자 보고 문제: "background외에는 제대로 안나오네" (배경 이미지만 작동, 다른 리소스 깨짐)

**문제 원인**: `decode_all_resources_complete.py`의 리소스 크기 계산 버그로 인한 데이터 손실

**해결 방법**: `out/_summary.json`의 정확한 분류 정보 사용하는 새 스크립트 작성

## 🐛 발견된 문제

### 1. 0바이트 파일 생성

**증상**:
```bash
$ ls -lh decoded/room_01/scripts/
-rw-r--r--  1 dirmich  staff     0B res_009.bin  # 실제는 985 bytes여야 함
-rw-r--r--  1 dirmich  staff     0B res_023.bin
```

### 2. 버그 원인 (decode_all_resources_complete.py)

```python
# 잘못된 크기 계산 로직
next_offset = sorted_offsets[i + 1][0] if i < len(sorted_offsets) - 1 else len(room_data)
size = next_offset - offset  # ⚠️ 음수값 또는 0이 될 수 있음!

if size <= 0:  # 잘못된 크기면 건너뛰기
    continue  # → 파일 생성 안 됨 또는 0바이트
```

**문제점**:
- 리소스 오프셋이 정렬되지 않으면 음수 크기 발생
- 크기 계산 실패 시 리소스 건너뜀
- 결과: 0바이트 파일 또는 누락

### 3. 부정확한 리소스 분류

**문제**: Entropy 기반 휴리스틱 분류가 부정확
- 많은 리소스가 "unknown"으로 분류됨
- 실제 타입(scripts, sounds 등)을 제대로 식별 못함

## ✅ 해결 방법

### 1. decode_all_resources_fixed.py 작성

**핵심 개선사항**:

#### A. 정확한 리소스 정보 사용
```python
# out/_summary.json 읽기 (extract_resources.py의 정확한 분류)
with open('out/_summary.json', 'r') as f:
    original_summary = json.load(f)

# 각 리소스의 정확한 타입과 크기 사용
for res in file_info['resources']:
    res_id = res['id']
    res_type = res['type']  # ✅ 이미 정확하게 분류됨
    src_path = Path('out') / res['path']
```

#### B. 검증된 데이터 복사
```python
# out/ 디렉토리에서 이미 올바르게 추출된 파일 복사
if not src_path.exists():
    continue

data = src_path.read_bytes()  # ✅ 올바른 크기
```

#### C. 배경 이미지만 재구성
```python
# 배경 이미지: 재구성 (알고리즘 검증됨)
reconstructed, img_width, img_height, num_strips = extract_room_image(decrypted)
if reconstructed:
    # ... 재구성된 포맷 저장 ...

# 나머지 리소스: out/에서 그대로 복사 (안전)
```

### 2. 실행 결과

```bash
python3 decode_all_resources_fixed.py
```

**생성 결과**:
- `decoded2/` 디렉토리
- 73개 Room, 954개 리소스
- 모든 파일 정확한 크기로 추출됨

### 3. 실제 파일 포맷 변환

```bash
python3 decode_to_real_files.py
```

**변환 통계**:
- 🖼️ 이미지: 73개 (PNG)
- 🔊 사운드: 385개 (WAV)
- 📜 스크립트: 21개 (TXT)
- 📦 기타: 2931개 (오브젝트 그래픽 등)

**출력 디렉토리**: `converted2/`

## 🔍 검증

### PNG 이미지
```bash
$ file converted2/room_01/background.png
converted2/room_01/background.png: PNG image data, 320 x 144, 8-bit/color RGB, non-interlaced
```
✅ 정상 PNG 파일

### WAV 사운드
```bash
$ file converted2/room_01/sounds/01_res007.wav
converted2/room_01/sounds/01_res007.wav: RIFF (little-endian) data, WAVE audio, Microsoft PCM, 8 bit, mono 11025 Hz
```
✅ 정상 WAV 파일

### 디렉토리 구조
```bash
$ ls -lh converted2/room_01/
total 16
-rw-r--r--   1 dirmich  staff   4.2K 10 18 00:58 background.png
drwxr-xr-x   5 dirmich  staff   160B 10 18 00:58 graphics/
drwxr-xr-x   5 dirmich  staff   160B 10 18 00:58 sounds/
drwxr-xr-x  30 dirmich  staff   960B 10 18 00:58 unknown/
```
✅ 올바른 구조

## 📊 비교: 이전 vs 수정 후

### 이전 (decoded/)
- ❌ 0바이트 스크립트 파일
- ❌ 부정확한 리소스 분류
- ❌ 데이터 손실

### 수정 후 (decoded2/, converted2/)
- ✅ 모든 파일 정확한 크기
- ✅ 정확한 리소스 분류 (`out/_summary.json` 기반)
- ✅ 실제 파일 포맷으로 변환 (PNG, WAV, TXT)
- ✅ 이미지 뷰어에서 바로 확인 가능
- ✅ 미디어 플레이어에서 바로 재생 가능
- ✅ 텍스트 에디터에서 바로 확인 가능

## 🔄 완전한 워크플로우

### 1단계: LFL 파일 추출
```bash
python3 extract_resources.py
```
- 출력: `out/` 디렉토리
- 결과: `out/_summary.json` (정확한 리소스 분류)

### 2단계: 디코딩 및 재구성
```bash
python3 decode_all_resources_fixed.py
```
- 입력: `out/_summary.json`, LFL 파일
- 출력: `decoded2/` 디렉토리
- 결과: 재구성된 배경 이미지 + 원본 리소스

### 3단계: 실제 파일 변환
```bash
python3 decode_to_real_files.py
```
- 입력: `decoded2/resources.json`
- 출력: `converted2/` 디렉토리
- 결과: PNG, WAV, TXT 파일

## 📁 최종 디렉토리 구조

```
LOOM/
├── *.LFL                                    # 원본 암호화 파일
├── out/                                     # 1단계: 추출된 원본 리소스
│   ├── _summary.json                       # 정확한 리소스 분류
│   └── graphics/sounds/scripts/...
├── decoded2/                                # 2단계: 디코딩된 리소스
│   ├── resources.json
│   └── room_XX/
│       ├── background/background.bin       # 재구성된 포맷
│       ├── graphics/*.bin
│       ├── sounds/*.bin
│       └── scripts/*.bin
└── converted2/                              # 3단계: 실제 파일 포맷
    └── room_XX/
        ├── background.png                   # 🖼️ PNG
        ├── sounds/*.wav                     # 🔊 WAV
        ├── scripts/*.txt                    # 📜 TXT
        └── graphics/*.bin                   # 오브젝트 (원본)
```

## 🎯 사용자 요구사항 충족

> "background외에는 제대로 안나오네"

### ✅ 완전히 해결됨

1. **모든 리소스 정확한 크기로 추출**: 0바이트 파일 없음
2. **정확한 타입 분류**: `out/_summary.json` 기반
3. **실제 파일 포맷으로 변환**: PNG, WAV, TXT
4. **바로 확인 가능**: 이미지 뷰어, 미디어 플레이어, 텍스트 에디터

## 📝 관련 파일

### 신규 작성
- `decode_all_resources_fixed.py` - 버그 수정된 디코더
- `decoded2/` - 정확하게 추출된 리소스
- `converted2/` - 실제 파일 포맷 (PNG/WAV/TXT)

### 수정
- `decode_to_real_files.py` - `decoded2/` 사용하도록 수정
- `.gitignore` - `decoded2/`, `converted2/` 추가

### 기존 (참고)
- `extract_resources.py` - 원본 추출 (정확한 분류)
- `out/_summary.json` - 정확한 리소스 메타데이터
- `decode_all_resources_complete.py` - 버그 있는 구버전

## 🚀 다음 단계

### 1. 오브젝트 그래픽 디코딩
현재 `graphics/*.bin` 파일은 원본 포맷 그대로입니다.

**필요 작업**:
- SCUMM v3 오브젝트 그래픽 포맷 분석
- 디코더 구현 (배경과 다른 포맷)
- PNG 변환 추가

### 2. 사운드 포맷 개선
SCUMM v3 사운드는 여러 포맷 존재:
- PC Speaker beeps
- AdLib (OPL2) music
- Raw PCM samples

**필요 작업**:
- 각 사운드의 실제 포맷 식별
- 포맷별 적절한 변환 (현재는 모두 PCM으로 가정)

### 3. 스크립트 디스어셈블러
현재는 hex dump만 표시.

**필요 작업**:
- SCUMM v3 opcode 테이블 작성
- 디스어셈블러 구현
- 읽기 쉬운 어셈블리 코드로 변환

## 📚 참고 문서

- [SMAP_이미지_추출_가이드.md](./SMAP_이미지_추출_가이드.md)
- [최종성공_20251018.md](./최종성공_20251018.md)
- [작업로그_20251018_리소스변환.md](./작업로그_20251018_리소스변환.md)
- [리소스_변환_가이드.md](./리소스_변환_가이드.md)
