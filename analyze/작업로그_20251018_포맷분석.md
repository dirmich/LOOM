# 작업 로그 - 2025-10-18: SCUMM v3 포맷 분석

## 📋 사용자 보고 문제

1. **사운드**: "sound는 제대로 안들리고"
2. **스크립트**: "script는 문장으로 나오지 않네?"

## 🔍 문제 분석

### 사운드 문제

**현재 구현**:
```python
# decode_to_real_files.py
def convert_sound_to_wav(data, output_path):
    # 모든 사운드를 raw PCM으로 가정
    sample_rate = 11025
    with wave.open(str(output_path), 'wb') as wav:
        wav.setnchannels(1)  # Mono
        wav.setsampwidth(1)  # 8-bit
        wav.setframerate(sample_rate)
        wav.writeframes(data)  # ⚠️ 잘못된 가정!
```

**실제 포맷**:
```
사운드 분석 결과 (총 385개):
- AdLib (v3): 3개 - FM synthesis data
- PC Speaker (v3): 20개 - Simple beep data
- Unknown: 362개 - Cannot identify format
```

**문제 원인**:
- SCUMM v3 사운드는 **악기 음악 데이터** (MIDI 기반)
- PC Speaker beeps 또는 AdLib FM synthesis 명령어
- Raw PCM 오디오 샘플이 아님
- 단순 WAV 변환 불가능

**데이터 예시**:
```
00000000  00 00 00 00 00 00 00 00  00 00 bd 00 0c 00 2e 00
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^  ^^  ^^  ^^  ^^  ^^
          침묵                           AdLib 레지스터 명령
```

### 스크립트 문제

**현재 구현**:
```python
# decode_to_real_files.py
def disassemble_script(data, output_path):
    # Hex dump만 출력
    for i in range(0, len(data), 16):
        chunk = data[i:i+16]
        hex_str = ' '.join(f'{b:02X}' for b in chunk)
        f.write(f'{i:04X}  {hex_str}\n')
```

**출력 예시**:
```
0000  0F 00 00 80 0F 01 00 00 0F 02 00 80 0F 01 00 00
0010  0F 01 00 00 0F 01 00 80 0F 01 00 80 0F 01 00 00
```

**실제 포맷**:
- SCUMM v3 바이트코드
- Opcode (1 byte) + 파라미터 (word/byte)
- 예: `0F 00 00 80` → opcode 0x0F + 3개 파라미터

**필요한 작업**:
디스어셈블러로 변환:
```
0F 00 00 80  → animateActor(0, 128)
0F 01 00 00  → animateActor(1, 0)
```

## 🛠️ 해결 방법 조사

### ScummVM 참고 자료

#### 1. 사운드
- **위키**: [SCUMM/Technical Reference/Sound resources](https://wiki.scummvm.org/index.php?title=SCUMM/Technical_Reference/Sound_resources)
- **소스**: `scummvm/engines/scumm/sound.cpp`
- **포맷**: SPK (PC Speaker), ADL (AdLib), ROL (Roland MT-32)

**v5+ 구조**:
```
"SPK " or "ADL " or "ROL "  // 4 bytes - 블록 타입
[size]                       // 4 bytes - 데이터 크기
[MIDI-like data]             // variable - 음악 데이터
```

**v3 구조**: 헤더 없음, 직접 데이터

#### 2. 스크립트
- **도구**: [descumm](https://github.com/scummvm/scummvm-tools/blob/master/engines/scumm/descumm.cpp)
- **참고**: [SCUMM Bytecode Deep Dive](https://tonick.net/p/2021/03/a-deep-dive-into-the-scumm-bytecode/)
- **사용법**: `descumm -3 script.bin`

## ✅ 구현한 해결책

### 1. 리소스 포맷 분석 도구

**파일**: `analyze_resources.py`

**기능**:
- 사운드 포맷 식별 (AdLib, PC Speaker, Unknown)
- 포맷별 통계 및 예시
- 권장 해결 방법 안내

**실행 결과**:
```
🔍 LOOM 리소스 포맷 분석
======================================================================

📊 사운드 포맷 분석 (총 385개)
  🔊 AdLib (v3): 3개
  🔊 PC Speaker (v3): 20개
  🔊 Unknown: 362개

💡 권장 사항
1. 🎮 게임 플레이: ScummVM 사용
2. 🔊 사운드 추출: MIDI 변환 구현 필요
3. 📜 스크립트 읽기: descumm 도구 사용
```

### 2. 포맷 분석 문서

**파일**: `SCUMM_V3_포맷_분석.md`

**내용**:
- 사운드/스크립트 포맷 상세 설명
- 해결 방법 (단기/장기)
- ScummVM 도구 사용법
- 참고 자료 링크

## 💡 실용적 해결책

### 즉시 사용 가능

#### 1. ScummVM으로 게임 플레이 (권장) ✅
```bash
# https://www.scummvm.org/ 다운로드
# LOOM 폴더 추가
# → 완벽한 사운드, 그래픽, 스크립트 실행
```

#### 2. descumm으로 스크립트 디스어셈블
```bash
# ScummVM-tools 설치
git clone https://github.com/scummvm/scummvm-tools.git
cd scummvm-tools
./configure && make

# SCUMM v3 스크립트 디스어셈블
./descumm -3 decoded2/room_00/scripts/00_res001.bin > output.txt
```

**출력 예시** (추정):
```
// Script 00_res001
animateActor(0, 128);
animateActor(1, 0);
animateActor(2, 128);
...
```

### 고급 구현 (시간 필요)

#### 1. 사운드 변환
**요구사항**:
- ScummVM 소스코드 분석
- PC Speaker 에뮬레이터 구현
- AdLib (OPL2) 에뮬레이터 구현
- WAV 렌더링

**작업량**: 수일~수주

#### 2. 자체 디스어셈블러
**요구사항**:
- SCUMM v3 opcode 테이블 작성 (101개)
- 파라미터 파싱 로직
- 읽기 쉬운 출력 포맷

**작업량**: 수일

## 📊 결론

### 현재 상태
- ✅ **배경 이미지**: 완벽하게 PNG 변환 (73개)
- ⚠️ **사운드**: WAV 생성했지만 재생 불가 (385개)
  - 이유: MIDI 기반 악기 데이터, raw PCM 아님
- ⚠️ **스크립트**: TXT 생성했지만 hex dump만 (21개)
  - 이유: 바이트코드, 디스어셈블 필요

### 권장 사항
1. **게임 플레이**: ScummVM 사용 (가장 간단)
2. **학습 목적**: descumm 도구로 스크립트 분석
3. **완전한 추출**: ScummVM 소스 참고하여 고급 구현

## 📁 생성 파일

- `analyze_resources.py` - 리소스 포맷 분석 도구
- `SCUMM_V3_포맷_분석.md` - 포맷 상세 분석 및 해결 방법
- `작업로그_20251018_포맷분석.md` - 이 문서

## 🔗 참고 자료

- [ScummVM Official](https://www.scummvm.org/)
- [ScummVM Wiki - Sound Resources](https://wiki.scummvm.org/index.php?title=SCUMM/Technical_Reference/Sound_resources)
- [ScummVM-tools (descumm)](https://github.com/scummvm/scummvm-tools)
- [SCUMM Bytecode Deep Dive](https://tonick.net/p/2021/03/a-deep-dive-into-the-scumm-bytecode/)
- [ScummVM Sound Source](https://github.com/scummvm/scummvm/blob/master/engines/scumm/sound.cpp)

## 🎯 다음 단계 (선택사항)

1. **descumm 통합**: Python에서 descumm 도구 호출하여 스크립트 자동 디스어셈블
2. **사운드 포맷 개선**: ScummVM 소스 참고하여 PC Speaker/AdLib 디코더 구현
3. **오브젝트 그래픽**: 아직 디코딩 안 된 graphics/*.bin 파일 처리
